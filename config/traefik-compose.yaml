x-logging: &default-logging
  driver: json-file
  options:
    max-size: '2m'
    max-file: '5'
    mode: non-blocking

services:
  reverse-proxy:
    image: traefik:${TRAEFIK_VERSION:-latest}
    container_name: traefik
    restart: ${RESTART_POLICY:-unless-stopped}
    logging: *default-logging
    entrypoint: ["/scripts/traefik-entrypoint.sh"]
    ## Note: Traefik configuration is now handled by the entrypoint script
    ## which conditionally configures only the appropriate ACME challenge type
    ## based on the LE_CHALLENGE environment variable.
    ## 
    ## To use TLS-ALPN challenge (default):
    ##   LE_CHALLENGE=tls (or leave unset)
    ## 
    ## To use DNS-01 challenge (for wildcard certificates):
    ##   LE_CHALLENGE=dns
    ##   LE_DNS_PROVIDER=cloudflare (or other supported provider)
    ##   [Provider-specific credentials - see .env.example]
    ##
    ## For debugging, you can add: - --log.level=DEBUG
    ## For staging LE server, uncomment the caserver line in traefik-entrypoint.sh
    env_file: ${SL_CONFIG_PATH:-${PWD:-.}/.env}
    ports:
      - "80:80"
      - "443:443"
    networks:
      - traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-acme:/etc/traefik/acme
      - ${PWD:-.}/scripts:/scripts:ro
    extra_hosts:
      - host.docker.internal:host-gateway
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]

volumes:
  traefik-acme:
    name: traefik-acme

networks:
  traefik:
    name: traefik
    driver: bridge
